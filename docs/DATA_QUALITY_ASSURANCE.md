# 数据质量保证文档

## 1. 概述

本文档定义了股票数据库系统的数据质量保证标准和检查范围。系统的核心目标是确保从外部数据源导入的数据在存储后具有高质量、一致性和完整性，为上层应用提供可靠的数据基础。

### 1.1 质量保证原则

- **完整性优先**：确保关键业务数据不缺失
- **准确性保证**：验证数据逻辑正确性和合理性
- **一致性维护**：保证数据间的关联关系正确
- **及时性监控**：确保数据更新的时效性

### 1.2 质量检查维度

#### 完整性（Completeness）
- 数据记录完整性：检查表是否有数据
- 字段完整性：检查关键字段的NULL值比例
- 时间序列完整性：检查连续时间数据的缺失
- 关联完整性：检查表间关联关系的完整性

#### 唯一性（Uniqueness）
- 主键唯一性：确保主键字段无重复
- 业务逻辑唯一性：检查业务上应该唯一的记录

#### 准确性（Accuracy）
- 数值合理性：检查数值是否在合理范围内
- 逻辑一致性：验证数据内部逻辑关系
- 格式规范性：检查数据格式是否符合标准
- 计算准确性：验证计算字段的正确性

#### 时效性（Timeliness）
- 数据新鲜度：检查最后更新时间
- 更新频率：验证数据更新是否按预期频率进行

## 2. 整体数据质量标准

### 2.1 数据完整性标准

| 严重程度 | 缺失比例阈值 | 处理要求 |
|---------|------------|----------|
| 严重 | > 30% | 立即停止使用，排查数据源 |
| 警告 | 10-30% | 监控趋势，计划修复 |
| 正常 | < 10% | 可接受范围 |

### 2.2 数据准确性标准

| 检查项 | 容忍度 | 处理策略 |
|-------|--------|----------|
| 价格逻辑错误 | 0% | 立即修复 |
| 财务数据平衡 | 1%误差 | 警告监控 |
| 异常波动 | 50%涨跌幅 | 记录异常 |

### 2.3 数据时效性标准

- **交易日数据**：T+1日更新完成
- **财务数据**：财报发布后5个工作日内更新
- **用户数据**：实时或次日更新

## 3. 分表质量检查范围

### 3.1 股票基础信息表 (stock_list)

**表概述**：存储所有股票的基本信息和市场分类

**关键字段**：
- `code`: 股票代码（主键）
- `display_name`: 股票名称
- `start_date`: 上市日期
- `end_date`: 退市日期
- `exchange`: 交易所代码
- `status`: 股票状态

**质量检查项**：

#### 完整性检查
- 表记录数检查：不能为空
- 关键字段完整性：`code`, `display_name`, `start_date` 不能为NULL
- 活跃股票覆盖：检查主要交易所活跃股票是否齐全

#### 唯一性检查
- 主键唯一性：`code` 字段不能重复
- 业务唯一性：同一股票不能有多条有效记录

#### 准确性检查
- 股票代码格式：必须符合 `.SH/.SZ/.BJ` 格式
- 日期逻辑：`end_date` 不能早于 `start_date`
- 交易所映射：`exchange` 字段必须为有效值（XSHG/XSHE/BSE）
- 状态有效性：`status` 必须为有效状态值

#### 时效性检查
- 新股及时性：新上市股票应在上市日后及时添加
- 退市及时性：退市股票应及时更新退市日期

### 3.2 价格数据表 (price_data)

**表概述**：存储股票日K线数据，包括开高低收量等信息

**关键字段**：
- `code`: 股票代码
- `day`: 交易日期
- `open/high/low/close`: 开高低收价格
- `volume`: 成交量
- `amount`: 成交额

**质量检查项**：

#### 完整性检查
- 时间序列完整性：活跃股票应覆盖所有交易日
- 股票覆盖完整性：所有活跃股票应有价格数据
- 关键字段完整性：价格和成交量字段不能为NULL

#### 唯一性检查
- 联合主键唯一性：(`code`, `day`) 组合不能重复

#### 准确性检查
- 价格逻辑性：`high >= max(open, close)`, `low <= min(open, close)`
- 价格合理性：价格必须为正数
- 异常波动检测：单日涨跌幅不超过设定阈值（默认50%）
- 成交量合理性：成交量不能为负数
- 停牌数据处理：停牌期间应有相应标识

#### 时效性检查
- 最新数据及时性：最新交易日数据应及时更新
- 数据延迟监控：数据更新延迟不超过1个交易日

### 3.3 估值数据表 (valuation_data)

**表概述**：存储股票每日估值指标，如市值、市盈率等

**关键字段**：
- `code`: 股票代码
- `day`: 日期
- `market_cap`: 市值
- `pe_ratio`: 市盈率
- `pb_ratio`: 市净率

**质量检查项**：

#### 完整性检查
- 与价格数据一致性：有价格数据的日期应有对应估值数据
- 关键指标完整性：市值等核心指标不能大量缺失

#### 准确性检查
- 估值指标合理性：PE、PB等比率在合理范围内
- 市值计算准确性：市值 = 股价 × 总股本
- 指标逻辑性：避免极端异常值

### 3.4 技术指标表 (indicator_data)

**表概述**：存储技术分析指标数据

**关键字段**：
- `code`: 股票代码
- `stat_date`: 统计日期
- `eps`: 每股收益
- `roe`: 净资产收益率

**质量检查项**：

#### 完整性检查
- 指标计算完整性：基础数据存在时应有对应指标
- 时间周期一致性：按财报周期检查指标完整性

#### 准确性检查
- 指标计算准确性：验证指标计算公式正确性
- 指标合理性：EPS、ROE等指标在合理范围内

### 3.5 用户交易记录表 (user_transactions)

**表概述**：存储用户的股票交易明细

**关键字段**：
- `trade_id`: 交易ID（主键）
- `user_id`: 用户ID
- `stock_code`: 股票代码
- `trade_date`: 交易日期
- `trade_type`: 交易类型（23-买入，24-卖出）
- `quantity`: 交易数量
- `price`: 交易价格
- `amount`: 交易金额

**质量检查项**：

#### 完整性检查
- 关键字段完整性：交易ID、用户ID、股票代码等不能为NULL
- 股票代码有效性：交易的股票代码必须在股票列表中存在

#### 唯一性检查
- 交易ID唯一性：`trade_id` 不能重复

#### 准确性检查
- 交易类型有效性：`trade_type` 必须为23或24
- 数量价格合理性：数量和价格必须为正数
- 金额计算准确性：交易金额 = 数量 × 价格（考虑舍入误差）
- 股票代码格式：必须符合标准格式
- 交易日期有效性：必须为有效的交易日

### 3.6 用户持仓记录表 (user_positions)

**表概述**：存储用户每日持仓快照

**关键字段**：
- `position_id`: 持仓ID（主键）
- `user_id`: 用户ID
- `position_date`: 持仓日期
- `stock_code`: 股票代码
- `position_quantity`: 持仓数量
- `available_quantity`: 可用数量
- `market_value`: 持仓市值
- `current_price`: 当前价格

**质量检查项**：

#### 完整性检查
- 持仓记录连续性：检查用户持仓记录的时间连续性
- 关键字段完整性：用户ID、持仓日期、股票代码不能为NULL

#### 唯一性检查
- 联合主键唯一性：(`user_id`, `position_date`, `stock_code`) 不能重复

#### 准确性检查
- 数量逻辑性：持仓数量 >= 可用数量 + 冻结数量
- 市值计算准确性：市值 = 持仓数量 × 当前价格
- 价格合理性：当前价格必须为正数
- 负持仓检查：一般情况下持仓数量不应为负

### 3.7 用户账户信息表 (user_account_info)

**表概述**：存储用户账户资产汇总信息

**关键字段**：
- `user_id`: 用户ID
- `info_date`: 信息日期
- `total_assets`: 总资产
- `position_market_value`: 持仓市值
- `available_cash`: 可用资金

**质量检查项**：

#### 完整性检查
- 账户信息连续性：检查账户信息记录的时间连续性
- 关键字段完整性：用户ID、信息日期、总资产不能为NULL

#### 准确性检查
- 资产平衡检查：总资产 = 持仓市值 + 可用资金 + 冻结资金
- 金额合理性：各项金额不能为负数
- 数据一致性：持仓市值应与持仓明细汇总一致

## 4. 检查执行策略

### 4.1 检查级别

#### 快速检查 (quick)
- **执行频率**：每日数据更新后
- **执行时间**：1-2分钟
- **检查范围**：核心表（股票列表、价格数据、用户数据）
- **抽样策略**：100只股票样本
- **适用场景**：日常监控、快速验证

#### 标准检查 (standard)
- **执行频率**：每周执行一次
- **执行时间**：5-10分钟
- **检查范围**：所有数据表
- **抽样策略**：500只股票样本
- **适用场景**：全面诊断、定期评估

### 4.2 问题分级处理

#### 严重问题 (Critical)
- **定义**：影响业务正常运行的问题
- **处理时限**：立即处理
- **示例**：主键重复、表为空、关键数据逻辑错误
- **处理措施**：停止相关数据使用，立即修复

#### 警告问题 (Warning)
- **定义**：可能影响数据质量但不阻断业务
- **处理时限**：24小时内评估
- **示例**：轻微数据缺失、异常波动
- **处理措施**：监控趋势，计划修复

### 4.3 监控机制

#### 自动监控
- 数据更新后自动执行快速检查
- 异常情况自动记录日志
- 严重问题触发告警机制

#### 人工复核
- 定期查看检查报告
- 分析问题趋势和根因
- 调整检查策略和阈值

## 5. 质量改进措施

### 5.1 预防措施
- 数据源稳定性监控
- 导入流程异常检测
- 数据格式标准化

### 5.2 修复措施
- 自动修复简单问题（如格式标准化）
- 数据回溯和补齐
- 异常数据隔离

### 5.3 持续改进
- 定期评估检查规则有效性
- 根据业务需求调整质量标准
- 完善检查覆盖范围

## 6. 相关工具和命令

### 6.1 检查命令
```bash
# 快速检查
python main.py check-data

# 标准检查
python main.py check-data --level standard

# 指定表检查
python main.py check-data --tables stock_list,price_data

# 生成详细报告
python main.py check-data --output-report logs/quality_report.json
```

### 6.2 报告查看
- 控制台实时输出问题概要
- JSON格式详细报告包含完整问题列表
- 日志文件记录检查执行历史

## 7. 附录

### 7.1 数据类型映射
| 业务表名 | 系统标识 | 数据源 |
|---------|---------|--------|
| 股票列表 | stock_list | JQData/Tushare |
| 价格数据 | price_data | JQData |
| 估值数据 | valuation_data | JQData |
| 技术指标 | indicator_data | JQData |
| 用户数据 | user_transactions, user_positions, user_account_info | 导入文件 |

### 7.2 关键配置参数
- `price_change_limit`: 价格异常波动阈值（默认50%）
- `null_ratio_warning`: NULL值警告阈值（默认10%）
- `null_ratio_critical`: NULL值严重阈值（默认30%）
- `sample_size_quick`: 快速检查抽样数量（默认100）
- `sample_size_standard`: 标准检查抽样数量（默认500）